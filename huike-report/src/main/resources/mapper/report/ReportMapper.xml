<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.huike.report.mapper.ReportMapper">

    <select id="getCluesNum" resultType="Integer">
        SELECT COUNT(DISTINCT (id)) AS cluesNum
        FROM `tb_clue`
        WHERE id IN (SELECT assign_id
                     FROM `tb_assign_record`
                     WHERE DATE_FORMAT(create_time, '%Y-%m-%d') BETWEEN #{startTime}
                         AND #{endTime}
                       AND `type` = 0
                       AND `latest` = 1
                       AND `user_name` = #{username})
          AND `status` IN (1, 2)
    </select>

    <select id="getBusinessNum" resultType="Integer">
        SELECT COUNT(DISTINCT (id)) AS businessNum
        FROM `tb_business`
        WHERE id IN (SELECT assign_id
                     FROM `tb_assign_record`
                     WHERE DATE_FORMAT(`create_time`, '%Y-%m-%d') BETWEEN #{startTime}
                         AND #{endTime}
                       AND `type` = 1
                       AND `latest` = 1
                       AND `user_name` = #{username})
          AND `status` IN (1, 2)
    </select>

    <select id="getContractNum" resultType="Integer">
        SELECT COUNT(DISTINCT (id)) AS contractNum
        FROM `tb_contract`
        WHERE DATE_FORMAT(`create_time`, '%Y-%m-%d') BETWEEN #{startTime}
            AND #{endTime}
          AND create_by = #{username}
          AND `status` = 4
    </select>

    <select id="getSalesAmount" resultType="Double">
        SELECT CAST(
                       IFNULL(SUM(h.`contract_order`), 0) AS DECIMAL(30, 0)
                   ) AS salesAmount
        FROM `tb_contract` h
        WHERE h.create_by = #{username}
          AND DATE_FORMAT(h.create_time, '%Y-%m-%d') BETWEEN #{startTime}
            AND #{endTime}
    </select>
    <select id="getAllContractNum" resultType="java.lang.Integer">
        SELECT COUNT(id) AS clueNum
        FROM tb_clue
        <where>
            <if test="startTime != null  and startTime != ''">
                and DATE_FORMAT(create_time, '%Y-%m-%d')  <![CDATA[>=]]> #{startTime}
            </if>
            <if test="endTime != null and endTime !=''">
                and  DATE_FORMAT(end_time, '%Y-%m-%d') <![CDATA[<=]]> #{endTime}
            </if>
        </where>
    </select>
    <select id="geteffectiveContractNum" resultType="java.lang.Integer">
        SELECT count(id) as contractNum
        FROM tb_clue
        where
            status in
        <foreach item="status" collection="customerIdList" separator="," open="(" close=")" index="">
            #{status, jdbcType=INTEGER}
        </foreach>
            <if test="startTime ！= null and startTime !=''">
                and create_time <![CDATA[>=]]> #{startTime}
            </if>
            <if test="endtime ！= null and endtime !=''">
                and end_time <![CDATA[<=]]> #{endtime}
            </if>
    </select>
    <select id="getTofollowedCluesNum" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT (id)) AS TofollowedCluesNum
        FROM `tb_clue`
        WHERE DATE_FORMAT(`create_time`, '%Y-%m-%d') BETWEEN #{startTime}
            AND #{endTime}
          AND `status` =1
    </select>
    <select id="getTofollowedBusinessNum" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT (id)) AS tofollowedBusinessNum
        FROM `tb_business`
        WHERE DATE_FORMAT(`create_time`, '%Y-%m-%d') BETWEEN #{startTime}
            AND #{endTime}
          AND `status` in ('1','3','4')
    </select>
    <select id="getToallocatedCluesNum" resultType="java.lang.Integer">
        SELECT COUNT(id) AS toallocatedCluesNum FROM tb_clue
WHERE id in (Select DISTINCT (assign_id) FROM tb_assign_record)
    </select>
    <select id="getToallocatedBusinessNum" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT (id)) AS tofollowedBusinessNum
        FROM `tb_business`
        WHERE DATE_FORMAT(`create_time`, '%Y-%m-%d') BETWEEN #{startTime}
            AND #{endTime}
          AND `status` in ('3','4')
    </select>


</mapper>